{% include "./common/header.html" %}
<link rel="stylesheet" href="{{ url_for('static',filename='./place_order/place_order.css') }}" xmlns="http://www.w3.org/1999/html">

<script>
    // Validate all the input fields to get the no of products
    function validate(pppID, tqID, qrID, disID, tpID, dpID) {
        var idl = "quantity";
        var n = document.getElementById("tableID").rows.length - 1;

        for (var i = 0; i < n; i++) {
            var quantity = document.getElementById("quantity" + i);
            var totalQuantity = document.getElementById("tquantity" + i);

            if (parseInt(quantity.value) > parseInt(totalQuantity.innerText)) {
                alert("Sorry !! \nWe have only " + totalQuantity.innerText + " units in our Stock.");
                quantity.value = totalQuantity.innerText;
            } else {
                quantity = Math.min(parseInt(quantity.value), parseInt(totalQuantity.innerHTML));
                quantity = Math.max(parseInt(quantity.value), 0);
                quantity.value = quantity.value;
            }
        }
        updateTotalPrice(pppID, qrID, disID, tpID, dpID);
    }

    // Update the total price the the customer needs to give
    function updateTotalPrice(pppID, qrID, disID, tpID, dpID) {
        var price = document.getElementById(pppID).innerText;
        var qty = document.getElementById(qrID).value;
        var tprice = document.getElementById(tpID);
        tprice.innerText = price * qty;
        updateDiscount(qrID, disID, tpID, dpID);
    }

    // Update the discounted price that the customer needs to give
    function updateDiscount(qrID, disID, tpID, dpID) {
        var qty = document.getElementById(qrID).value;
        var discount = document.getElementById(disID);
        var cost = document.getElementById(tpID);
        var fcost = document.getElementById(dpID);

        if (discount != null && cost != null) {
            disc = discount.value.split(" ")[0];

            if (parseInt(qty) >= parseInt(discount.value.split(" ")[1])) {
                fcost.innerText = cost.innerText - (cost.innerText * (disc / 100));
            } else {
                fcost.innerText = cost.innerText;
            }
        } else {
            fcost.innerText = cost.innerText;
        }
    }

    // Prevent Enter key from performing any function
    $(document).ready(function() {
        $(window).keydown(function(event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                return false;
            }
        });
    });
</script>

<body>
    <h2> Place your Orders here </h2>

    {% if products %}
    <div class="container">
        <form id="form" method="post" action="">
            <table class="table table-bordered" id="tableID">
                <tr>
                    <th> Product </th>
                    <th> Category </th>
                    <th> Price Per Piece </th>
                    <th> Quantity in Stock</th>
                    <th> Quantity Required </th>
                    <th> Select Discount (%) </th>
                    <th> Total Amount </th>
                    <th> Discounted Amount </th>

                </tr>
                {% for item in products %}
                <tr>
                    <td> {{item['Name']}} - <br>
                        <font size="2dp"> {{item['Description']}} </font>
                    </td>
                    <td> {{item['Category']}} </td>
                    <td value="{{item['Price']}}" id="price{{loop.index0}}"> {{item['Price']}} </td>
                    <td value="{{item['Quantity']}}" id="tquantity{{loop.index0}}"> {{item['Quantity']}} </td>
                    <td>
                        <input name="qty[]" type="number" id="quantity{{loop.index0}}" min="0" max="{{item[ 'Quantity']}}" value="0" onchange="validate( 'price{{loop.index0}}', 'tquantity{{loop.index0}}', 'quantity{{loop.index0}}', 'offerOptions{{loop.index0}}',
                            'tprice{{loop.index0}}', 'dprice{{loop.index0}}')">
                    </td>
                    <td>
                        {% if offers[item['ProductID']]|length > 0 %}
                        <select name="offerOptions" id="offerOptions{{loop.index0}}" onchange="updateDiscount('quantity{{loop.index0}}', 'offerOptions{{loop.index0}}', 'tprice{{loop.index0}}', 'dprice{{loop.index0}}')">
                                <option value="0 0" selected="true "> No discount </option>
                                {% for offer in offers[item['ProductID']] %}
                                <option value="{{offer['DiscountPercentage']}} {{offer['QuantityRequired']}}"> {{offer['Information']}} </option>{% endfor %}
                            </select> {% else %} {{"No offers"}} {% endif %}
                    </td>
                    <td id="tprice{{loop.index0}}"> </td>
                    <td value={{item[ 'Price']}} id="dprice{{loop.index0}}"> {{item['Price']}} </td>

                </tr>
                {% if offers[item['ProductID']]|length > 0 %}
                <script>
                    updateDiscount('quantity{{loop.index0}}', 'offerOptions{{loop.index0}}', 'tprice{{loop.index0}}', 'dprice{{loop.index0}}');
                </script>
                {% endif %}

                <script>
                    updateTotalPrice('price{{loop.index0}}', 'quantity{{loop.index0}}', 'offerOptions{{loop.index0}}', 'tprice{{loop.index0}}', 'dprice{{loop.index0}}');
                </script>

                {% endfor %}
            </table>
            <input type="hidden" value="{{products}}" name="details" />
            <input type="submit" value="ADD TO CART" />
        </form>
    </div>
    {% endif %}
</body>

<script src="{{ url_for( 'static',filename='./place_order/cart_feature.js' )}}"></script>